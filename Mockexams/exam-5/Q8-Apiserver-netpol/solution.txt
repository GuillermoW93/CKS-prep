# First get the Kubernetes ClusterIP

'k get svc' 

or

API_SERVER_IP=$(kubectl get svc kubernetes -n default -o jsonpath='{.spec.clusterIP}')

# Create Network Policy that blocks Kubernetes API for all pods

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-server-policy
  namespace: api-restrict
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - ${API_SERVER_IP}/32

# Allow pods with label role=admin to access the Kubernetes API

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-admin-api-egress
  namespace: api-restrict

spec:
  podSelector:
    matchLabels:
      role: admin

  policyTypes:
    - Egress

  egress:
    - to:
        - ipBlock:
            cidr: ${API_SERVER_IP}/32
      ports:
        - protocol: TCP
          port: 443


# Verify connectivity

apiVersion: v1
kind: Pod
metadata:
  name: admin-pod
  namespace: api-restrict
  labels:
    role: admin
spec:
  containers:
    - name: busybox
      image: busybox
      command: ["sleep", "3600"]

apiVersion: v1
kind: Pod
metadata:
  name: restricted-pod
  namespace: api-restrict
  labels:
    role: restricted
spec:
  containers:
    - name: busybox
      image: busybox
      command: ["sleep", "3600"]

